<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Облегченный скрапер Kindle Cloud Reader (оптимизирован для Replit)</title>
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container mt-4">
        <nav class="nav nav-pills nav-fill mb-4">
            <a class="nav-link" href="/">Главная</a>
            <a class="nav-link" href="/test_api_scraper">API скрапер</a>
            <a class="nav-link" href="/test_web_scraper">Веб-скрапер</a>
            <a class="nav-link" href="/test_auto_api_scraper">Авто API скрапер</a>
            <a class="nav-link" href="/test_enhanced_api_scraper">Расширенный API скрапер</a>
            <a class="nav-link active" href="/test_light_scraper">Облегченный скрапер</a>
        </nav>

        <div class="card bg-dark mb-4">
            <div class="card-body">
                <h1 class="card-title">Облегченный скрапер Kindle Cloud Reader</h1>
                <p class="card-text">
                    Этот скрапер оптимизирован для работы в ограниченной среде Replit. 
                    Он использует минимум ресурсов и работает без Selenium, что делает его 
                    более стабильным при ограничениях системы.
                </p>
                <p class="card-text">
                    <strong>Особенности:</strong>
                    <ul>
                        <li>Не использует Selenium - работает через прямые HTTP-запросы</li>
                        <li>Потребляет минимум памяти и CPU</li>
                        <li>Более стабильная работа в ограниченной среде</li>
                        <li>Эффективное извлечение структурированного текста книги</li>
                    </ul>
                </p>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-5">
                <div class="card bg-dark mb-4">
                    <div class="card-header">
                        <h5>Параметры запуска</h5>
                    </div>
                    <div class="card-body">
                        <form id="scraper-form">
                            <div class="mb-3">
                                <label for="book_url" class="form-label">URL книги в Kindle Cloud Reader</label>
                                <input type="text" class="form-control" id="book_url" name="book_url" placeholder="https://read.amazon.com/kp/kcc?asin=..." required>
                                <small class="text-muted">URL страницы с открытой книгой. Пример: https://read.amazon.com/kp/kcc?asin=B009SE1Z9E</small>
                            </div>

                            <div class="mb-3">
                                <label for="email" class="form-label">Email Amazon (опционально)</label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="your.email@example.com">
                                <small class="text-muted">Если книга требует авторизации</small>
                            </div>

                            <div class="mb-3">
                                <label for="password" class="form-label">Пароль Amazon (опционально)</label>
                                <input type="password" class="form-control" id="password" name="password">
                                <small class="text-muted">Используется только если указан email</small>
                            </div>

                            <div class="mb-3">
                                <label for="output_file" class="form-label">Имя файла для сохранения</label>
                                <input type="text" class="form-control" id="output_file" name="output_file" value="kindle_light_book.txt">
                            </div>

                            <div class="mb-3">
                                <label for="max_pages" class="form-label">Максимальное количество страниц для обработки</label>
                                <input type="number" class="form-control" id="max_pages" name="max_pages" value="50" min="1" max="500">
                                <small class="text-muted">Ограничивает количество страниц, чтобы не перегружать систему</small>
                            </div>

                            <button type="submit" class="btn btn-primary" id="start-btn">Запустить скрапер</button>
                            <button type="button" class="btn btn-danger d-none" id="stop-btn">Остановить</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="card bg-dark mb-4">
                    <div class="card-header">
                        <h5>Статус выполнения</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3 d-none" id="progress-container">
                            <label for="progress" class="form-label" id="progress-label">Прогресс: 0%</label>
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" id="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small class="text-muted" id="page-info">Страница 0 из 0</small>
                        </div>
                        <div class="log-container">
                            <h6>Лог операций:</h6>
                            <div id="log-output" class="bg-dark text-light p-2 rounded" style="height: 400px; overflow-y: scroll; font-family: monospace;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scraperForm = document.getElementById('scraper-form');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressLabel = document.getElementById('progress-label');
            const pageInfo = document.getElementById('page-info');
            const logOutput = document.getElementById('log-output');
            
            let logMessages = [];
            let statusCheckInterval;
            
            // Обработчик отправки формы
            scraperForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Очищаем лог
                logOutput.innerHTML = '';
                logMessages = [];
                
                // Получаем данные формы
                const formData = new FormData(scraperForm);
                formData.append('method', 'light');  // Указываем метод 'light'
                
                // Делаем недоступными элементы формы
                toggleFormElements(true);
                
                // Отображаем прогресс-бар
                progressContainer.classList.remove('d-none');
                
                // Отправляем запрос на запуск скрапера
                fetch('/start_scraping', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        appendLog('Скрапер запущен');
                        startStatusChecking();
                    } else {
                        appendLog('Ошибка: ' + data.message);
                        toggleFormElements(false);
                    }
                })
                .catch(error => {
                    appendLog('Ошибка при отправке запроса: ' + error);
                    toggleFormElements(false);
                });
            });
            
            // Обработчик кнопки остановки
            stopBtn.addEventListener('click', function() {
                fetch('/stop_scraping')
                .then(response => response.json())
                .then(data => {
                    appendLog('Отправлен запрос на остановку процесса');
                })
                .catch(error => {
                    appendLog('Ошибка при отправке запроса остановки: ' + error);
                });
            });
            
            // Функция для проверки статуса скрапера
            function startStatusChecking() {
                statusCheckInterval = setInterval(checkStatus, 1000);
            }
            
            // Функция проверки статуса
            function checkStatus() {
                fetch('/get_status')
                .then(response => response.json())
                .then(data => {
                    updateProgress(data.progress);
                    updatePageInfo(data.current_page, data.total_pages);
                    
                    // Обновляем лог, если есть новые сообщения
                    if (data.log_messages && data.log_messages.length > 0) {
                        for (const message of data.log_messages) {
                            if (!logMessages.includes(message)) {
                                appendLog(message);
                                logMessages.push(message);
                            }
                        }
                    }
                    
                    // Если процесс завершен, разблокируем форму
                    if (!data.running) {
                        clearInterval(statusCheckInterval);
                        toggleFormElements(false);
                    }
                })
                .catch(error => {
                    appendLog('Ошибка при проверке статуса: ' + error);
                });
            }
            
            // Функция обновления прогресс-бара
            function updateProgress(progress) {
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                progressLabel.textContent = 'Прогресс: ' + progress + '%';
            }
            
            // Функция обновления информации о страницах
            function updatePageInfo(currentPage, totalPages) {
                pageInfo.textContent = 'Страница ' + currentPage + ' из ' + totalPages;
            }
            
            // Функция для добавления сообщения в лог
            function appendLog(message) {
                const logLine = document.createElement('div');
                logLine.textContent = message;
                logOutput.appendChild(logLine);
                logOutput.scrollTop = logOutput.scrollHeight;
            }
            
            // Функция для переключения доступности элементов формы
            function toggleFormElements(disabled) {
                const formElements = scraperForm.querySelectorAll('input, button[type="submit"]');
                formElements.forEach(element => {
                    element.disabled = disabled;
                });
                
                if (disabled) {
                    startBtn.classList.add('d-none');
                    stopBtn.classList.remove('d-none');
                } else {
                    startBtn.classList.remove('d-none');
                    stopBtn.classList.add('d-none');
                }
            }
        });
    </script>
</body>
</html>